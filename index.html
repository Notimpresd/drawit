<!doctype html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8">
<title>Drawit</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root{
    /* Dark defaults */
    --bg:#111; --panel:#151515; --line:#222; --text:#eee;
    --btn:#222; --btn2:#2b2b2b; --btn3:#3a2f6b; --bd:#444; --bd2:#5c57a0; --sh:#0008;
    --accent:#7b6dff; --canvas:#0d0d0d;
    --bar-h:64px; --sidebar-w:240px;
  }
  [data-theme="light"]{
    --bg:#f6f7fb; --panel:#ffffff; --line:#dfe3f0; --text:#111;
    --btn:#f1f3f9; --btn2:#e8ebf5; --btn3:#dfe3ff; --bd:#cfd6ea; --bd2:#a5aef0; --sh:#0002;
    --accent:#5b55ff; --canvas:#f4f6fb;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;}
  .only-mobile{display:none} .only-desktop{display:initial}

  /* Top bar */
  #topbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;
          padding:8px 10px;height:var(--bar-h);background:var(--panel);border-bottom:1px solid var(--line);
          position:fixed;top:0;left:0;right:0;z-index:10}
  input,button{background:var(--btn);color:var(--text);border:1px solid var(--bd);padding:6px 10px;border-radius:10px}
  button{cursor:pointer;box-shadow:0 3px 0 var(--sh),0 0 0 1px #0001 inset;
         transition:transform .12s,background-color .15s,border-color .15s,box-shadow .15s}
  button:hover{background:var(--btn2)}
  button:active{background:var(--btn3);border-color:var(--bd2);transform:translateY(1px);box-shadow:0 2px 0 var(--sh),0 0 0 1px #0001 inset}
  .small{font-size:12px;opacity:.75}
  .grow{flex:1 1 auto}
  #size{width:64px}

  /* Layout */
  #sidebar{position:fixed;top:var(--bar-h);bottom:0;left:0;width:var(--sidebar-w);
           border-right:1px solid var(--line);background:var(--panel);padding:10px 10px 12px;overflow:auto;z-index:9}
  #canvas{position:fixed;top:var(--bar-h);left:var(--sidebar-w);right:0;bottom:0;background:var(--canvas);cursor:crosshair}

  .section-title{font-weight:700;margin:2px 0 6px;opacity:.9}
  .subtle{font-size:12px;opacity:.75;margin:4px 0 10px}
  .card{background:var(--btn2);border:1px solid var(--bd);border-radius:12px;padding:8px 10px;margin-bottom:10px}
  .pill{display:flex;align-items:center;gap:8px;background:transparent;padding:6px 8px;border:1px solid var(--bd);border-radius:10px;margin-bottom:6px}
  .dot{width:14px;height:14px;border-radius:50%;border:1px solid #0003;box-shadow:0 0 0 1px #0002 inset}
  .iconbtn{padding:4px 6px;line-height:1;border-radius:8px}
  .poke{margin-left:auto}

  /* Toast */
  #toast{position:fixed;top:calc(var(--bar-h) + 10px);left:50%;transform:translateX(-50%);z-index:20;pointer-events:none}
  .toast{background:var(--panel);border:1px solid var(--bd);padding:10px 14px;border-radius:10px;box-shadow:0 10px 30px #0006;opacity:0}
  .toast.show{animation:fadeSlide 1.8s ease forwards}
  @keyframes fadeSlide{
    0%{opacity:0; transform:translate(-50%, -6px)}
    10%{opacity:1; transform:translate(-50%, 0)}
    80%{opacity:1}
    100%{opacity:0; transform:translate(-50%, -6px)}
  }

  /* Login overlay */
  #overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter: blur(6px);
           display:flex;align-items:center;justify-content:center;z-index:30}
  .login-card{width:min(92vw, 420px);background:var(--panel);border:1px solid var(--bd);border-radius:16px;
              box-shadow:0 20px 60px #0008;padding:20px}
  .title{font-weight:700;font-size:28px;margin:4px 0 14px}
  .subtitle{opacity:.8;margin:-6px 0 18px}
  .field{display:flex;gap:8px}
  .field input{flex:1}
  .hint{font-size:12px;opacity:.78;margin-top:8px;display:none;color:#ff8080}
  .play{background:var(--accent);border-color:#9b92ff;color:#fff}

  /* Mobile drawer */
  @media (max-width: 900px){
    :root{ --bar-h: 56px; }
    .only-mobile{display:initial} .only-desktop{display:none}
    #sidebar{ width:min(85vw, 320px); transform:translateX(-100%); transition:transform .2s ease; box-shadow:none }
    body.mobile-drawer-open #sidebar{ transform:translateX(0); box-shadow:8px 0 20px #000a }
    #drawerScrim{position:fixed;inset:0;background:#0008;z-index:8;display:none}
    body.mobile-drawer-open #drawerScrim{display:block}
    #canvas{left:0}
  }
</style>
</head>
<body>
<!-- Top bar -->
<div id="topbar">
  <button id="shareBtn" title="Copy invite link">üîó Share</button>

  <span class="only-desktop">üñåÔ∏è Brush (Wheel)</span>
  <input id="size" type="number" min="1" max="50" step="1" value="4" aria-label="Brush size">
  <div class="only-mobile" style="display:flex;gap:6px">
    <button id="minusSize" title="Smaller">‚àí</button>
    <button id="plusSize"  title="Bigger">+</button>
  </div>

  <button id="undo" title="Ctrl+Z">‚Ü©Ô∏è Undo (Ctrl+Z)</button>
  <button id="clear" title="C">üßπ Clear All (C)</button>

  <div class="grow"></div>

  <button id="themeToggle" title="Toggle theme">üåó Theme</button>
  <span id="badge">Peers: 0</span>
  <span id="wsdebug" class="small" style="margin-left:8px;">Connecting...</span>
  <button id="playersBtn" class="only-mobile" style="margin-left:8px">Players</button>
</div>

<!-- Sidebar -->
<div id="sidebar" aria-label="Players drawer">
  <div class="section-title">You</div>
  <div class="subtle">This is your identity in the room</div>
  <div class="card">
    <div class="pill">
      <span class="dot" id="meDot"></span>
      <span id="meName">‚Ä¶</span>
    </div>
  </div>

  <div class="section-title" style="margin-top:12px">Players connected</div>
  <div class="subtle">Everyone here can draw with you</div>
  <div id="roster" style="padding:6px 0 0"></div>
</div>
<div id="drawerScrim" class="only-mobile"></div>

<!-- Canvas -->
<canvas id="canvas"></canvas>

<!-- Toasts -->
<div id="toast"></div>

<!-- Login overlay -->
<div id="overlay">
  <div class="login-card">
    <div class="title">Drawit</div>
    <div class="subtitle">Enter your name to start</div>
    <div class="field">
      <input id="loginName" placeholder="Your name" maxlength="24" autocomplete="name">
      <button id="playBtn" class="play">‚ñ∂ Play</button>
    </div>
    <div id="nameHint" class="hint"></div>
  </div>
</div>

<script>
(function(){
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d', { alpha:false });

  const sizeInput = document.getElementById('size');
  const minusBtn  = document.getElementById('minusSize');
  const plusBtn   = document.getElementById('plusSize');

  const wsdebug   = document.getElementById('wsdebug');
  const badge     = document.getElementById('badge');
  const meName = document.getElementById('meName');
  const meDot  = document.getElementById('meDot');
  const rosterBox = document.getElementById('roster');

  const playersBtn = document.getElementById('playersBtn');
  const scrim = document.getElementById('drawerScrim');
  const themeToggle = document.getElementById('themeToggle');
  const shareBtn = document.getElementById('shareBtn');

  const undoBtn = document.getElementById('undo');
  const clearBtn= document.getElementById('clear');

  const login = document.getElementById('overlay');
  const playBtn = document.getElementById('playBtn');
  const loginName = document.getElementById('loginName');
  const nameHint = document.getElementById('nameHint');

  const toastWrap = document.getElementById('toast');
  const MOBILE_Q = window.matchMedia('(max-width: 900px)');

  // Fit canvas
  function fit(){
    const desktop = !MOBILE_Q.matches;
    const leftPad = desktop ? parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sidebar-w')) : 0;
    const barH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--bar-h'));
    canvas.width  = window.innerWidth - leftPad;
    canvas.height = window.innerHeight - barH;
  }
  window.addEventListener('resize', fit); fit();
  MOBILE_Q.addEventListener?.('change', fit);

  // Theme
  const root = document.documentElement;
  function applyTheme(t){ root.setAttribute('data-theme', t); localStorage.setItem('drawitTheme', t); }
  (function initTheme(){
    const saved = localStorage.getItem('drawitTheme');
    if (saved) applyTheme(saved);
    else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) applyTheme('light');
    else applyTheme('dark');
  })();
  themeToggle.addEventListener('click', ()=>{
    applyTheme(root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
  });

  // Drawer (mobile)
  function openDrawer(){ document.body.classList.add('mobile-drawer-open'); }
  function closeDrawer(){ document.body.classList.remove('mobile-drawer-open'); }
  playersBtn?.addEventListener('click', openDrawer);
  scrim?.addEventListener('click', closeDrawer);

  // Toasts
  function showToast(text){
    const el = document.createElement('div');
    el.className = 'toast show';
    el.textContent = text;
    toastWrap.appendChild(el);
    setTimeout(()=> el.remove(), 1900);
  }

  // Share button (fixed URL)
  const SHARE_URL = "https://drawit-o0jo.onrender.com/";
  shareBtn.addEventListener('click', async ()=>{
    try{
      await navigator.clipboard.writeText(SHARE_URL);
      showToast("Link copied");
    }catch(e){ showToast("Copy failed"); }
  });

  // Device id (blocks multiple sessions per device)
  function deviceId(){
    let d = localStorage.getItem('drawitDevice');
    if (!d){
      d = Array.from(crypto.getRandomValues(new Uint8Array(16))).map(b=>b.toString(16).padStart(2,'0')).join('');
      localStorage.setItem('drawitDevice', d);
    }
    return d;
  }

  // Brush size & wheel ¬±1
  const me = { id:null, name:null, color:"#ffffff", size:Number(sizeInput.value)||4 };
  function clampSize(v){ return Math.max(1, Math.min(50, Math.round(v))); }
  sizeInput.addEventListener('input', ()=>{
    let v = parseFloat(sizeInput.value);
    if (Number.isFinite(v)) me.size = clampSize(v);
  });
  minusBtn?.addEventListener('click', ()=>{
    let v = clampSize((Number(sizeInput.value)||me.size||4) - 1);
    sizeInput.value = String(v); me.size = v;
  });
  plusBtn?.addEventListener('click', ()=>{
    let v = clampSize((Number(sizeInput.value)||me.size||4) + 1);
    sizeInput.value = String(v); me.size = v;
  });
  canvas.addEventListener('wheel', (e)=>{
    e.preventDefault();
    let v = Number(sizeInput.value) || me.size || 4;
    v += (e.deltaY < 0 ? 1 : -1);
    v = clampSize(v);
    sizeInput.value = String(v);
    me.size = v;
  }, {passive:false});

  // Hotkeys
  function sendClearAll(){ send({type:'clearAll'}); }
  function sendUndo(){ send({type:'undoMine'}); }
  window.addEventListener('keydown', (e)=>{
    const key = (e.key || '').toLowerCase();
    if ((e.ctrlKey || e.metaKey) && key === 'z'){ e.preventDefault(); sendUndo(); }
    else if (!e.ctrlKey && !e.metaKey && key === 'c'){ e.preventDefault(); sendClearAll(); }
  });

  // WS
  let ws;
  function send(obj){ try{ ws && ws.readyState===1 && ws.send(JSON.stringify(obj)); }catch(e){} }
  const wsUrl = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws';

  async function connect(){
    ws = new WebSocket(wsUrl);
    ws.onopen = ()=>{
      wsdebug.textContent = "Connected";
      send({type:'hello', name: pendingName, device: deviceId()});
    };
    ws.onclose = ()=>{ wsdebug.textContent = "Disconnected"; setTimeout(connect, 800); };
    ws.onerror = ()=>{ wsdebug.textContent = "Error"; };
    ws.onmessage = ev => handle(JSON.parse(ev.data));
  }

  function renderRoster(peers){
    rosterBox.innerHTML = "";
    badge.textContent = "Peers: " + peers.length;
    const others = peers.filter(p => p.id !== me.id);
    for (const p of others) {
      const div = document.createElement('div');
      div.className = "pill";
      const dot = document.createElement('span');
      dot.className = "dot"; dot.style.background = p.color;
      const name = document.createElement('span');
      name.textContent = p.name;
      const poke = document.createElement('button');
      poke.className = 'iconbtn poke'; poke.title = 'Poke'; poke.textContent = 'üëà';
      poke.addEventListener('click', ()=> send({type:'poke', to: p.id}));
      div.appendChild(dot); div.appendChild(name); div.appendChild(poke);
      rosterBox.appendChild(div);
    }
  }

  // Drawing
  ctx.lineCap = "round"; ctx.lineJoin = "round";
  let drawing = false, last = null, sid = 0;

  function drawSeg(x0,y0,x1,y1,color,size){
    ctx.beginPath(); ctx.moveTo(x0,y0); ctx.lineTo(x1,y1);
    ctx.strokeStyle=color; ctx.lineWidth=size; ctx.stroke();
  }
  function drawDot(x,y,color,size){
    const r = Math.max(1, size / 2);
    ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2);
    ctx.fillStyle=color; ctx.fill();
  }
  const pos = e => {
    const rect = canvas.getBoundingClientRect();
    return {x: e.clientX - rect.left, y: e.clientY - rect.top};
  };

  canvas.addEventListener('mousedown', e=>{
    drawing = true; last = pos(e); sid = (sid+1)|0;
    drawDot(last.x, last.y, me.color, me.size);
    send({type:'dot', x:last.x, y:last.y, size:me.size, sid});
  });
  window.addEventListener('mouseup', ()=>{ drawing=false; last=null; });
  canvas.addEventListener('mousemove', e=>{
    if (!drawing) return;
    const p = pos(e);
    drawSeg(last.x,last.y,p.x,p.y, me.color, me.size);
    send({type:'draw', x0:last.x, y0:last.y, x1:p.x, y1:p.y, size:me.size, sid});
    last = p;
  });

  const handle = (msg)=>{
    if (!msg || !msg.type) return;

    if (msg.type === 'needName') {
      // Show specific hint only when invalid
      nameHint.style.display = 'block';
      nameHint.textContent = (msg.reason === 'short') ? 'Name must be at least 3 characters'
                           : (msg.reason === 'chars') ? 'Only letters, numbers, spaces, - and _ are allowed'
                           : 'Please enter a valid name';
      login.style.display = 'flex';
      loginName.focus(); loginName.select();
      return;
    }
    if (msg.type === 'banned') {
      nameHint.style.display = 'block';
      nameHint.textContent = 'Blocked: already logged in on this device';
      login.style.display = 'flex';
      return;
    }

    if (msg.type === 'welcome') {
      me.id = msg.id; me.name = msg.name; me.color = msg.color;
      meName.textContent = me.name; meDot.style.background = me.color;
      login.style.display = 'none'; nameHint.style.display = 'none';
      return;
    }
    if (msg.type === 'roster') { renderRoster(msg.peers || []); return; }

    if (msg.type === 'history') {
      const evts = msg.events || [];
      for (const e of evts) {
        if (e.type === 'draw') drawSeg(e.x0, e.y0, e.x1, e.y1, e.color, e.size);
        else if (e.type === 'dot') drawDot(e.x, e.y, e.color, e.size);
      }
      return;
    }
    if (msg.type === 'rebuild') {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const evts = msg.events || [];
      for (const e of evts) {
        if (e.type === 'draw') drawSeg(e.x0, e.y0, e.x1, e.y1, e.color, e.size);
        else if (e.type === 'dot') drawDot(e.x, e.y, e.color, e.size);
      }
      return;
    }
    if (msg.type === 'draw') { drawSeg(msg.x0, msg.y0, msg.x1, msg.y1, msg.color, msg.size); return; }
    if (msg.type === 'dot')  { drawDot(msg.x, msg.y, msg.color, msg.size); return; }
    if (msg.type === 'boop') { showToast(`${msg.fromName} booped you!`); return; }
  };

  // Name validation (show hint only if invalid)
  function validNameChars(s){ return /^[A-Za-z0-9 _-]+$/.test(s); }
  function tryPlay(){
    const n = (loginName.value||"").trim();
    if (n.length < 3){
      nameHint.style.display='block'; nameHint.textContent='Name must be at least 3 characters'; return;
    }
    if (!validNameChars(n)){
      nameHint.style.display='block'; nameHint.textContent='Only letters, numbers, spaces, - and _ are allowed'; return;
    }
    // OK: connect
    pendingName = n;
    nameHint.style.display='none';
    connect();
  }

  let pendingName = "";
  playBtn.addEventListener('click', tryPlay);
  loginName.addEventListener('keydown', e=>{ if (e.key==='Enter') tryPlay(); });
  setTimeout(()=> loginName.focus(), 50);

  // Top buttons
  undoBtn.addEventListener('click', ()=> send({type:'undoMine'}));
  clearBtn.addEventListener('click', ()=> send({type:'clearAll'}));
})();
</script>
</body>
</html>

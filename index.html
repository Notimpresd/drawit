<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>LAN Free Draw</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root{
    --bar-h: 64px;
    --btn-bg:#222; --btn-bg-hover:#2b2b2b; --btn-bg-press:#3a2f6b;
    --btn-border:#444; --btn-border-press:#5c57a0; --btn-shadow:#0008;
    --sidebar-w:240px;
  }
  html,body{height:100%;margin:0;background:#111;color:#eee;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;}
  #topbar { display:flex; gap:10px; align-items:center; padding:8px 10px; height:var(--bar-h);
            background:#161616; border-bottom:1px solid #222; position:fixed; top:0; left:0; right:0; z-index:10; flex-wrap:wrap; }
  input, button { background:var(--btn-bg); color:#eee; border:1px solid var(--btn-border); padding:6px 10px; border-radius:10px; }
  button{ cursor:pointer; box-shadow:0 3px 0 var(--btn-shadow), 0 0 0 1px #0002 inset;
          transition: transform .12s ease, background-color .15s ease, border-color .15s ease, filter .15s ease, box-shadow .15s ease; }
  button:hover{ background:var(--btn-bg-hover); }
  button:active{ background:var(--btn-bg-press); border-color:var(--btn-border-press); transform:translateY(1px); box-shadow:0 2px 0 var(--btn-shadow), 0 0 0 1px #0002 inset; }
  #sharelink{ width:380px; }
  #size{ width:64px; }
  .small{ font-size:12px; opacity:.7; }
  #sidebar{ position:fixed; top:var(--bar-h); bottom:0; left:0; width:var(--sidebar-w); border-right:1px solid #222; background:#151515; padding:8px; overflow:auto; }
  #canvas{ position:fixed; top:var(--bar-h); left:var(--sidebar-w); right:0; bottom:0; background:#0d0d0d; cursor:crosshair; }
  .pill{ display:flex; align-items:center; gap:8px; background:#1b1b1b; padding:6px 8px; border:1px solid #333; border-radius:12px; margin-bottom:6px; }
  .dot{ width:14px; height:14px; border-radius:50%; border:1px solid #0008; box-shadow:0 0 0 1px #0004 inset; }
  .btnrow{ display:flex; gap:8px; margin-top:6px; }
  .iconbtn{ padding:4px 6px; line-height:1; border-radius:8px; }
  .name-input{ width:100%; padding:5px 7px; border-radius:8px; }
  #roster{ padding:6px; }
</style>
</head>
<body>
<div id="topbar">
  <span>Share this link:</span>
  <input id="sharelink" readonly>
  <button id="copylink">Copy Link</button>

  <span style="margin-left:16px;">Brush:</span>
  <input id="size" type="number" min="1" max="50" step="1" value="4">
  <button id="undo">Undo</button>
  <button id="clear">Clear Mine</button>
  <span id="badge" style="margin-left:auto;">Peers: 0</span>
  <span id="wsdebug" class="small" style="display:block; width:100%;">Connecting...</span>
</div>

<div id="sidebar">
  <div id="me">
    <div class="pill" id="mePill">
      <span class="dot" id="meDot"></span>
      <span id="meName">connecting...</span>
      <button id="editName" class="iconbtn" title="Edit name" aria-label="Edit name">✎</button>
    </div>
    <div class="btnrow">
      <button id="undo2">Undo</button>
      <button id="clear2">Clear Mine</button>
    </div>
  </div>
  <div id="roster"></div>
</div>

<canvas id="canvas"></canvas>

<script>
(function(){
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d', { alpha:false });
  const sizeInput = document.getElementById('size');

  const copyBtn = document.getElementById('copylink');
  const shareInput = document.getElementById('sharelink');
  const wsdebug = document.getElementById('wsdebug');
  const badge = document.getElementById('badge');

  const meName = document.getElementById('meName');
  const meDot  = document.getElementById('meDot');
  const editBtn = document.getElementById('editName');
  const rosterBox = document.getElementById('roster');

  const undoBtn = document.getElementById('undo');
  const undoBtn2 = document.getElementById('undo2');
  const clearBtn = document.getElementById('clear');
  const clearBtn2 = document.getElementById('clear2');

  function fit(){ canvas.width = window.innerWidth - 240; canvas.height = window.innerHeight - parseInt(getComputedStyle(document.documentElement).getPropertyValue('--bar-h')); }
  window.addEventListener('resize', fit); fit();

  // Copy share link
  copyBtn.addEventListener('click', async ()=>{
    try { await navigator.clipboard.writeText(shareInput.value); copyBtn.textContent = 'Copied'; setTimeout(()=>copyBtn.textContent='Copy Link', 1000); }
    catch(e){ /* ignore */ }
  });

  const me = { id:null, name:null, color:"#ffffff", size:Number(sizeInput.value)||4 };

  // Live brush-size update while typing
  sizeInput.addEventListener('input', ()=>{
    let v = parseFloat(sizeInput.value);
    if (Number.isFinite(v)) {
      v = Math.max(1, Math.min(50, v));
      me.size = v;
    }
  });

  // Wheel over canvas: change size by ±1
  canvas.addEventListener('wheel', (e)=>{
    e.preventDefault();
    let v = Number(sizeInput.value) || me.size || 4;
    v += (e.deltaY < 0 ? 1 : -1);
    if (v < 1) v = 1;
    if (v > 50) v = 50;
    v = Math.round(v);
    sizeInput.value = String(v);
    me.size = v;
  }, {passive:false});

  let ws, httpUrl="", wsUrl="";
  function send(obj){ try{ ws && ws.readyState===1 && ws.send(JSON.stringify(obj)); }catch(e){} }

  async function detectLinks(){
    // fetch /whoami to build correct public links behind proxies
    const res = await fetch('/whoami', {cache:'no-store'});
    const info = await res.json();
    httpUrl = info.http_url; wsUrl = info.ws_url;
    shareInput.value = httpUrl;
  }

  async function connect(){
    ws = new WebSocket(wsUrl);
    ws.onopen = ()=>{ wsdebug.textContent = "Connected"; };
    ws.onclose = ()=>{ wsdebug.textContent = "Disconnected - retrying..."; setTimeout(connect, 800); };
    ws.onerror = ()=>{ wsdebug.textContent = "Socket error"; };
    ws.onmessage = ev => handle(JSON.parse(ev.data));
  }

  // Name edit UX
  function startRename(){
    const wrapper = document.getElementById('mePill');
    const current = me.name || "";
    const input = document.createElement('input');
    input.type = 'text';
    input.value = current;
    input.className = 'name-input';
    input.maxLength = 24;
    // replace text node with input temporarily
    wrapper.replaceChild(input, meName);
    input.focus();
    input.select();

    function finish(save){
      const newName = save ? (input.value || "").trim() : current;
      // restore span
      wrapper.replaceChild(meName, input);
      if (save && newName && newName !== current) {
        meName.textContent = newName;
        send({type:'rename', name:newName});
      } else {
        meName.textContent = current || "me";
      }
    }
    input.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter') finish(true);
      else if (e.key === 'Escape') finish(false);
    });
    input.addEventListener('blur', ()=> finish(true));
  }
  editBtn.addEventListener('click', startRename);

  function renderRoster(peers){
    rosterBox.innerHTML = "";
    badge.textContent = "Peers: " + peers.length;
    const others = peers.filter(p => p.id !== me.id);
    for (const p of others) {
      const div = document.createElement('div');
      div.className = "pill";
      const dot = document.createElement('span');
      dot.className = "dot";
      dot.style.background = p.color;
      const name = document.createElement('span');
      name.textContent = p.name;
      div.appendChild(dot); div.appendChild(name);
      rosterBox.appendChild(div);
    }
  }

  // Drawing
  ctx.lineCap = "round"; ctx.lineJoin = "round";
  let drawing = false, last = null, sid = 0;

  function drawSeg(x0,y0,x1,y1,color,size){
    ctx.beginPath();
    ctx.moveTo(x0,y0); ctx.lineTo(x1,y1);
    ctx.strokeStyle=color; ctx.lineWidth=size;
    ctx.stroke();
  }
  function drawDot(x,y,color,size){
    const r = Math.max(1, size / 2);
    ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2);
    ctx.fillStyle=color; ctx.fill();
  }
  const pos = e => {
    const rect = canvas.getBoundingClientRect();
    return {x: e.clientX - rect.left, y: e.clientY - rect.top};
  };

  canvas.addEventListener('mousedown', e=>{
    drawing = true; last = pos(e); sid = (sid+1)|0;
    drawDot(last.x, last.y, me.color, me.size);
    send({type:'dot', x:last.x, y:last.y, size:me.size, sid});
  });
  window.addEventListener('mouseup', ()=>{ drawing=false; last=null; });
  canvas.addEventListener('mousemove', e=>{
    if (!drawing) return;
    const p = pos(e);
    drawSeg(last.x,last.y,p.x,p.y, me.color, me.size);
    send({type:'draw', x0:last.x, y0:last.y, x1:p.x, y1:p.y, size:me.size, sid});
    last = p;
  });

  const sendClear = ()=> send({type:'clearMine'});
  const sendUndo  = ()=> send({type:'undoMine'});
  clearBtn.addEventListener('click', sendClear);
  clearBtn2.addEventListener('click', sendClear);
  undoBtn.addEventListener('click', sendUndo);
  undoBtn2.addEventListener('click', sendUndo);

  function handle(msg){
    if (!msg || !msg.type) return;

    if (msg.type === 'welcome') {
      me.id = msg.id; me.name = msg.name; me.color = msg.color;
      meName.textContent = me.name;
      meDot.style.background = me.color;
      return;
    }
    if (msg.type === 'youRenamed') {
      if (msg.ok) { me.name = msg.name; meName.textContent = msg.name; }
      return;
    }
    if (msg.type === 'roster') {
      renderRoster(msg.peers || []);
      return;
    }
    if (msg.type === 'history') {
      const evts = msg.events || [];
      for (const e of evts) {
        if (e.type === 'draw') drawSeg(e.x0, e.y0, e.x1, e.y1, e.color, e.size);
        else if (e.type === 'dot') drawDot(e.x, e.y, e.color, e.size);
      }
      return;
    }
    if (msg.type === 'rebuild') {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const evts = msg.events || [];
      for (const e of evts) {
        if (e.type === 'draw') drawSeg(e.x0, e.y0, e.x1, e.y1, e.color, e.size);
        else if (e.type === 'dot') drawDot(e.x, e.y, e.color, e.size);
      }
      return;
    }
    if (msg.type === 'draw') { drawSeg(msg.x0, msg.y0, msg.x1, msg.y1, msg.color, msg.size); return; }
    if (msg.type === 'dot')  { drawDot(msg.x, msg.y, msg.color, msg.size); return; }
  }

  (async ()=>{ await detectLinks(); await connect(); })();
})();
</script>
</body>
</html>
